<!-- frequency.ejs - Bootstrap 5 Styled -->
<div class="container py-5">
  <!-- Breadcrumbs -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/cleaningType">1. Cleaning Details</a></li>
      <li class="breadcrumb-item"><a href="/extra">2. Extras</a></li>
      <li class="breadcrumb-item active">3. Date/Frequency</li>
      <li class="breadcrumb-item text-muted">4. Your Details</li>
      <li class="breadcrumb-item text-muted">5. Review</li>
      <li class="breadcrumb-item text-muted">6. Payment</li>
    </ol>
  </nav>

  <!-- Page Header -->
  <div class="text-center mb-5">
    <h1 class="display-5 fw-bold text-primary mb-3">Select Date & Frequency</h1>
    <p class="lead text-muted">Choose your service date, time, and how often you'd like service.</p>
  </div>

  <form action="/yourdetails-start" method="POST" id="frequencyForm">
    <!-- DATE AND TIME SELECTION -->
    <div class="row justify-content-center mb-5">
      <div class="col-md-6">
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <h3 class="h5 fw-bold text-center mb-4">Select Service Date</h3>
            
            <div class="mb-3">
              <label for="dateSelect" class="form-label">Service Date</label>
              <select name="requested_date" id="dateSelect" class="form-select" required>
                <option value="">Select a date...</option>
                <% if (typeof availableDates !== 'undefined' && availableDates.length > 0) { %>
                  <% availableDates.forEach(date => { %>
                    <option value="<%= typeof date.date === 'string' ? date.date : date.date.toISOString().split('T')[0] %>" data-date-id="<%= date.id %>">
                      <%= date.formatted || new Date(date.date).toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                      }) %>
                    </option>
                  <% }) %>
                <% } else { %>
                  <option value="" disabled>No available dates. Please check back later.</option>
                <% } %>
              </select>
              <small class="text-muted">Please select from available dates</small>
            </div>

            <div class="mb-3">
              <label for="timeSelect" class="form-label">Available Times</label>
              <select name="requested_time" id="timeSelect" class="form-select" required disabled>
                <option value="">Select a date first...</option>
              </select>
              <small class="text-muted">Please select a date to see available times</small>
            </div>
          </div>
        </div>
      </div>
    </div>

    <hr class="my-5">

    <!-- FREQUENCY SELECTION -->
    <div class="mb-5">
      <h3 class="h5 fw-bold text-center mb-4">Cleaning Frequency</h3>
      <div class="row g-3 justify-content-center">
        <% 
          const frequenciesList = typeof frequencies !== 'undefined' && frequencies.length > 0 
            ? frequencies 
            : [
                { value: "One-time", label: "One-time", icon: "ðŸ“…" },
                { value: "Weekly", label: "Weekly", icon: "ðŸ”„" },
                { value: "Bi-weekly", label: "Bi-weekly", icon: "ðŸ“†" }
              ];
        %>
        <% frequenciesList.forEach(freq => { %>
          <div class="col-6 col-md-4 col-lg-3">
            <label class="selection-card w-100" for="freq_<%= freq.value.replace(/\s+/g, '_') %>">
              <input
                type="radio"
                id="freq_<%= freq.value.replace(/\s+/g, '_') %>"
                name="frequency"
                value="<%= freq.value %>"
                required
              >
              <span class="card-icon" data-icon="freq_<%= freq.value %>"><%= freq.icon || 'ðŸ”„' %></span>
              <p class="mt-2 mb-0 fw-semibold"><%= freq.label %></p>
              <% if (freq.description) { %>
                <p class="small text-muted mt-1"><%= freq.description %></p>
              <% } %>
            </label>
          </div>
        <% }) %>
      </div>
    </div>

    <!-- Price Summary -->
    <% if (typeof priceInfo !== 'undefined' && priceInfo.subtotal > 0) { %>
      <div class="card bg-light border-primary border-2 shadow-sm mx-auto mb-4" style="max-width: 400px;">
        <div class="card-body text-center">
          <h5 class="card-title text-primary mb-3">Price Summary</h5>
          <p class="mb-2"><strong>Base Price:</strong> $<%= priceInfo.basePrice.toFixed(2) %></p>
          <p class="mb-2"><strong>Extras:</strong> +$<%= priceInfo.extrasTotal.toFixed(2) %></p>
          <p class="h5 fw-bold text-primary mb-2">
            Subtotal: $<%= priceInfo.subtotal.toFixed(2) %>
          </p>
          <small class="text-muted">Discount will be applied based on frequency</small>
        </div>
      </div>
    <% } %>

    <!-- Submit Button -->
    <div class="text-center mt-5">
      <button type="submit" class="btn btn-primary btn-lg px-5">
        Next â†’ Your Details <i class="bi bi-arrow-right ms-2"></i>
      </button>
    </div>
  </form>
</div>

<style>
.selection-card {
  transition: all 0.2s ease-in-out;
  cursor: pointer;
  border: 2px solid #dee2e6;
  border-radius: 0.75rem;
  min-height: 140px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  background: white;
  padding: 1.5rem;
}
.selection-card:hover {
  border-color: #E5482E;
  box-shadow: 0 4px 15px rgba(229, 72, 46, 0.15);
  transform: translateY(-2px);
}
.selection-card.selected {
  border-color: #E5482E;
  background-color: #fff5f3;
  box-shadow: 0 4px 15px rgba(229, 72, 46, 0.25);
}
.card-icon {
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
}
.card-icon.is-unchecked {
  color: #adb5bd;
}
.card-icon.is-checked {
  color: #E5482E;
}
input[type="radio"] {
  display: none;
}
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const dateSelect = document.getElementById("dateSelect");
  const timeSelect = document.getElementById("timeSelect");
  
  dateSelect.addEventListener("change", async () => {
    const dateId = dateSelect.options[dateSelect.selectedIndex].dataset.dateId;
    if (!dateId) {
      timeSelect.disabled = true;
      timeSelect.innerHTML = '<option value="">Select a date first...</option>';
      return;
    }
    
    try {
      const response = await fetch(`/api/time-slots/${dateId}`);
      const timeSlots = await response.json();
      
      timeSelect.innerHTML = '<option value="">Select a time...</option>';
      timeSlots.forEach(slot => {
        const option = document.createElement('option');
        option.value = slot.time_slot;
        option.textContent = slot.time_slot;
        timeSelect.appendChild(option);
      });
      timeSelect.disabled = false;
    } catch (error) {
      console.error('Error fetching time slots:', error);
    }
  });
  
  // Frequency selection behavior
  const form = document.getElementById("frequencyForm");
  const inputs = form.querySelectorAll("input[type='radio']");
  
  inputs.forEach(input => {
    const card = input.closest(".selection-card");
    const icon = card.querySelector("[data-icon]");
    
    if (input.checked) {
      card.classList.add("selected");
      icon.classList.add("is-checked");
    } else {
      icon.classList.add("is-unchecked");
    }
    
    card.addEventListener("click", () => {
      form.querySelectorAll(`input[name='${input.name}']`).forEach(i => {
        const c = i.closest(".selection-card");
        const ic = c.querySelector("[data-icon]");
        c.classList.remove("selected");
        ic.classList.remove("is-checked");
        ic.classList.add("is-unchecked");
      });
      
      input.checked = true;
      card.classList.add("selected");
      icon.classList.add("is-checked");
      icon.classList.remove("is-unchecked");
    });
  });
});
</script>



<%- include('../partials/header', { title: 'Dashboard - Ella Rises', user: typeof user !== 'undefined' ? user : null }) %>

<!-- Different dashboard for manager vs regular user -->
<% if (typeof user !== 'undefined' && user.role === 'manager') { %>
    <!-- Manager sees KPIs and metrics -->
    <div class="page-header">
        <h1>Dashboard</h1>
        <p>Track program effectiveness and impact metrics</p>
    </div>

    <div class="card mt-2">
        <h2 class="card-header">Analytics Dashboard</h2>
        <div class="tableau-placeholder" style="margin-top: 1.5rem;">
            <div class='tableauPlaceholder' id='viz1764809989550' style='position: relative; width: 100%;'>
                <noscript>
                    <a href='#'>
                        <img alt='Dashboard 4 ' src='https://public.tableau.com/static/images/El/EllaRises_17648078814950/Dashboard4/1_rss.png' style='border: none' />
                    </a>
                </noscript>
                <object class='tableauViz' style='display:none;'>
                    <param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' /> 
                    <param name='embed_code_version' value='3' /> 
                    <param name='site_root' value='' />
                    <param name='name' value='EllaRises_17648078814950&#47;Dashboard4' />
                    <param name='tabs' value='no' />
                    <param name='toolbar' value='yes' />
                    <param name='static_image' value='https://public.tableau.com/static/images/El/EllaRises_17648078814950/Dashboard4/1.png' /> 
                    <param name='animate_transition' value='yes' />
                    <param name='display_static_image' value='yes' />
                    <param name='display_spinner' value='yes' />
                    <param name='display_overlay' value='yes' />
                    <param name='display_count' value='yes' />
                    <param name='language' value='en-US' />
                </object>
            </div>
            <script type='text/javascript'>
                var divElement = document.getElementById('viz1764809989550');
                var vizElement = divElement.getElementsByTagName('object')[0];
                if (divElement.offsetWidth > 800) { 
                    vizElement.style.minWidth='420px';
                    vizElement.style.maxWidth='1280px';
                    vizElement.style.width='100%';
                    vizElement.style.minHeight='587px';
                    vizElement.style.maxHeight='887px';
                    vizElement.style.height=(divElement.offsetWidth*0.75)+'px';
                } else if (divElement.offsetWidth > 500) { 
                    vizElement.style.minWidth='420px';
                    vizElement.style.maxWidth='1280px';
                    vizElement.style.width='100%';
                    vizElement.style.minHeight='587px';
                    vizElement.style.maxHeight='887px';
                    vizElement.style.height=(divElement.offsetWidth*0.75)+'px';
                } else { 
                    vizElement.style.width='100%';
                    vizElement.style.height='1027px';
                }
                var scriptElement = document.createElement('script');
                scriptElement.src = 'https://public.tableau.com/javascripts/api/viz_v1.js';
                vizElement.parentNode.insertBefore(scriptElement, vizElement);
            </script>
        </div>
    </div>
<% } else { %>
    <!-- Regular user sees their registrations and surveys -->
    <div class="page-header">
        <h1>My Dashboard</h1>
        <p>Welcome, <%= user.username %>! View your program registrations.</p>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 class="card-header" style="margin: 0;">My Program Registrations</h2>
            <a href="/register" class="btn btn-primary">Register for Another Program</a>
        </div>
        
        <% if (typeof registrations !== 'undefined' && registrations.length > 0) { %>
            <div class="registrations-list">
                <% registrations.forEach(reg => { %>
                    <div class="registration-item" style="padding: 1.5rem; margin-bottom: 1rem; background: var(--pink-bg); border-radius: 8px; border-left: 4px solid var(--coral);">
                        <h3 style="margin: 0 0 0.5rem 0; color: var(--text-dark);"><%= reg.program %></h3>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.9rem;">
                            Registered on <%= new Date(reg.registrationDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                        </p>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <div style="padding: 3rem; text-align: center; background: var(--pink-bg); border-radius: 8px;">
                <p style="font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
                    You are not currently registered for any programs.
                </p>
                <a href="/register" class="btn btn-primary">Register for a Program</a>
            </div>
        <% } %>
    </div>

    <div class="card mt-2">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 class="card-header" style="margin: 0;">My Survey Responses</h2>
        </div>
        
        <% if (typeof surveys !== 'undefined' && surveys.length > 0) { %>
            <div class="surveys-list">
                <% surveys.forEach(survey => { %>
                    <div class="survey-item" style="padding: 1.5rem; margin-bottom: 1rem; background: var(--pink-bg); border-radius: 8px; border-left: 4px solid var(--coral);">
                        <h3 style="margin: 0 0 0.5rem 0; color: var(--text-dark);"><%= survey.eventName || 'Event' %></h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 0.75rem;">
                            <div>
                                <strong style="color: var(--text-secondary); font-size: 0.85rem;">Satisfaction:</strong>
                                <span style="color: var(--text-dark); font-weight: 600;"><%= survey.SatisfactionScore || survey.satisfaction_score || 'N/A' %>/5</span>
                            </div>
                            <div>
                                <strong style="color: var(--text-secondary); font-size: 0.85rem;">Usefulness:</strong>
                                <span style="color: var(--text-dark); font-weight: 600;"><%= survey.UsefulnessScore || survey.usefulness_score || 'N/A' %>/5</span>
                            </div>
                            <div>
                                <strong style="color: var(--text-secondary); font-size: 0.85rem;">Recommendation:</strong>
                                <span style="color: var(--text-dark); font-weight: 600;"><%= survey.RecommendationScore || survey.recommendation_score || 'N/A' %>/5</span>
                            </div>
                        </div>
                        <% if (survey.Comments || survey.comments) { %>
                            <p style="margin: 0.5rem 0 0 0; color: var(--text-dark); font-size: 0.9rem;">
                                <strong>Comments:</strong> <%= survey.Comments || survey.comments %>
                            </p>
                        <% } %>
                        <p style="margin: 0.75rem 0 0 0; color: var(--text-secondary); font-size: 0.85rem;">
                            Submitted on <%= new Date(survey.SurveySubmissionDate || survey.survey_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                        </p>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <div style="padding: 2rem; text-align: center; background: var(--pink-bg); border-radius: 8px;">
                <p style="font-size: 1rem; color: var(--text-secondary);">
                    You haven't submitted any survey responses yet.
                </p>
            </div>
        <% } %>
    </div>

    <div class="card mt-2">
        <h2 class="card-header">Quick Actions</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
            <a href="/register" class="btn btn-secondary" style="text-align: center; padding: 1rem;">Register for Program</a>
            <a href="/events" class="btn btn-secondary" style="text-align: center; padding: 1rem;">View All Events</a>
            <a href="/contact" class="btn btn-secondary" style="text-align: center; padding: 1rem;">Contact Us</a>
        </div>
    </div>
<% } %>

<%- include('../partials/footer') %>


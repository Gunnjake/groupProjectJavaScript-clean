<%- include('../partials/header', { title: 'Dashboard - Ella Rises', user: typeof user !== 'undefined' ? user : null }) %>

<!-- Different dashboard for manager vs regular user -->
<% if (typeof user !== 'undefined' && user.role === 'manager') { %>
    <!-- Manager sees KPIs and metrics -->
    <div class="page-header">
        <h1>Dashboard</h1>
        <p>Track program effectiveness and impact metrics</p>
    </div>

    <div class="card mt-2">
        <h2 class="card-header">Analytics Dashboard</h2>
        <div class="tableau-placeholder" style="margin-top: 1.5rem;">
            <div class='tableauPlaceholder' id='viz1764876550771' style='position: relative; width: 100%;'>
                <noscript>
                    <a href='#'>
                        <img alt='Dashboard 4 ' src='https://public.tableau.com/static/images/El/EllaRises7_0/Dashboard4/1_rss.png' style='border: none' />
                    </a>
                </noscript>
                <object class='tableauViz' style='display:none;'>
                    <param name='host_url' value='https%3A%2F%2Fpublic.tableau.com%2F' /> 
                    <param name='embed_code_version' value='3' /> 
                    <param name='site_root' value='' />
                    <param name='name' value='EllaRises7_0&#47;Dashboard4' />
                    <param name='tabs' value='no' />
                    <param name='toolbar' value='yes' />
                    <param name='static_image' value='https://public.tableau.com/static/images/El/EllaRises7_0/Dashboard4/1.png' /> 
                    <param name='animate_transition' value='yes' />
                    <param name='display_static_image' value='yes' />
                    <param name='display_spinner' value='yes' />
                    <param name='display_overlay' value='yes' />
                    <param name='display_count' value='yes' />
                    <param name='language' value='en-US' />
                    <param name='filter' value='publish=yes' />
                </object>
            </div>
            <script type='text/javascript'>
                var divElement = document.getElementById('viz1764876550771');
                var vizElement = divElement.getElementsByTagName('object')[0];
                if (divElement.offsetWidth > 800) { 
                    vizElement.style.minWidth='420px';
                    vizElement.style.maxWidth='1280px';
                    vizElement.style.width='100%';
                    vizElement.style.minHeight='587px';
                    vizElement.style.maxHeight='887px';
                    vizElement.style.height=(divElement.offsetWidth*0.75)+'px';
                } else if (divElement.offsetWidth > 500) { 
                    vizElement.style.minWidth='420px';
                    vizElement.style.maxWidth='1280px';
                    vizElement.style.width='100%';
                    vizElement.style.minHeight='587px';
                    vizElement.style.maxHeight='887px';
                    vizElement.style.height=(divElement.offsetWidth*0.75)+'px';
                } else { 
                    vizElement.style.width='100%';
                    vizElement.style.height='1527px';
                }
                var scriptElement = document.createElement('script');
                scriptElement.src = 'https://public.tableau.com/javascripts/api/viz_v1.js';
                vizElement.parentNode.insertBefore(scriptElement, vizElement);
            </script>
        </div>
    </div>
<% } else { %>
    <!-- Participant Dashboard -->
    <div class="page-header" style="margin-bottom: 2rem;">
        <h1 style="font-size: 2rem; font-weight: 600; color: var(--text-dark); margin-bottom: 0.25rem;">Dashboard</h1>
        <p style="font-size: 0.95rem; color: var(--text-secondary);">Welcome, <%= user.firstName || user.username || 'Participant' %></p>
    </div>

    <!-- Stats Overview -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
        <div class="card" style="border-left: 4px solid var(--coral); padding: 1.25rem;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; font-weight: 500;">Event Registrations</div>
            <div style="font-size: 2rem; font-weight: 600; color: var(--text-dark);"><%= typeof registrations !== 'undefined' ? registrations.length : 0 %></div>
        </div>
        <div class="card" style="border-left: 4px solid var(--lavender); padding: 1.25rem;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; font-weight: 500;">Survey Responses</div>
            <div style="font-size: 2rem; font-weight: 600; color: var(--text-dark);"><%= typeof surveys !== 'undefined' ? surveys.length : 0 %></div>
        </div>
        <div class="card" style="border-left: 4px solid var(--sage); padding: 1.25rem;">
            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.5rem; font-weight: 500;">Average Rating</div>
            <div style="font-size: 2rem; font-weight: 600; color: var(--text-dark);">
                <% 
                    if (typeof surveys !== 'undefined' && surveys.length > 0) {
                        let totalScore = 0;
                        let count = 0;
                        surveys.forEach(s => {
                            const sat = parseInt(s.SatisfactionScore || s.satisfaction_score || 0);
                            const use = parseInt(s.UsefulnessScore || s.usefulness_score || 0);
                            const rec = parseInt(s.RecommendationScore || s.recommendation_score || 0);
                            if (sat > 0) { totalScore += sat; count++; }
                            if (use > 0) { totalScore += use; count++; }
                            if (rec > 0) { totalScore += rec; count++; }
                        });
                        const avg = count > 0 ? (totalScore / count).toFixed(1) : '0.0';
                %>
                    <%= avg %>/5
                <% } else { %>
                    0.0/5
                <% } %>
            </div>
        </div>
    </div>

    <!-- Event Registrations Section -->
    <div class="card" style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 class="card-header" style="margin: 0;">Event Registrations</h2>
            <a href="/events" class="btn btn-primary">Register for Event</a>
        </div>
        
        <% if (typeof registrations !== 'undefined' && registrations.length > 0) { %>
            <div class="registrations-list">
                <% registrations.forEach(reg => { %>
                    <div class="registration-item" style="padding: 1.25rem; margin-bottom: 0.75rem; background: var(--pink-bg); border-radius: 6px; border-left: 3px solid var(--coral);">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h3 style="margin: 0 0 0.5rem 0; color: var(--text-dark); font-size: 1.1rem; font-weight: 600;"><%= reg.program %></h3>
                                <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem;">
                                    Registered on <%= new Date(reg.registrationDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                                </p>
                            </div>
                            <span style="background: var(--coral); color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; white-space: nowrap;">Registered</span>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <div style="padding: 3rem 2rem; text-align: center; background: var(--pink-bg); border-radius: 6px;">
                <p style="font-size: 1rem; color: var(--text-dark); margin-bottom: 0.5rem; font-weight: 500;">
                    No event registrations
                </p>
                <p style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1.5rem;">
                    Register for upcoming events to get started
                </p>
                <a href="/events" class="btn btn-primary">Browse Events</a>
            </div>
        <% } %>
    </div>

    <!-- Survey Responses Section -->
    <div class="card" style="margin-bottom: 2rem;">
        <h2 class="card-header" style="margin-bottom: 1.5rem;">Survey Responses</h2>
        
        <% if (typeof surveys !== 'undefined' && surveys.length > 0) { %>
            <div class="surveys-list">
                <% surveys.forEach(survey => { %>
                    <div class="survey-item" style="padding: 1.25rem; margin-bottom: 0.75rem; background: var(--pink-bg); border-radius: 6px; border-left: 3px solid var(--lavender);">
                        <h3 style="margin: 0 0 1rem 0; color: var(--text-dark); font-size: 1.1rem; font-weight: 600;"><%= survey.eventName || 'Event' %></h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem; font-weight: 500;">Satisfaction</div>
                                <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-dark);"><%= survey.SatisfactionScore || survey.satisfaction_score || 'N/A' %>/5</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem; font-weight: 500;">Usefulness</div>
                                <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-dark);"><%= survey.UsefulnessScore || survey.usefulness_score || 'N/A' %>/5</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem; font-weight: 500;">Recommendation</div>
                                <div style="font-size: 1.25rem; font-weight: 600; color: var(--text-dark);"><%= survey.RecommendationScore || survey.recommendation_score || 'N/A' %>/5</div>
                            </div>
                        </div>
                        <% if (survey.Comments || survey.comments) { %>
                            <div style="padding: 0.875rem; background: white; border-radius: 4px; margin-bottom: 0.75rem;">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.5rem; font-weight: 500;">Comments</div>
                                <p style="margin: 0; color: var(--text-dark); font-size: 0.875rem; line-height: 1.5;"><%= survey.Comments || survey.comments %></p>
                            </div>
                        <% } %>
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem;">
                            Submitted on <%= new Date(survey.SurveySubmissionDate || survey.survey_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) %>
                        </p>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <div style="padding: 3rem 2rem; text-align: center; background: var(--pink-bg); border-radius: 6px;">
                <p style="font-size: 1rem; color: var(--text-dark); margin-bottom: 0.5rem; font-weight: 500;">
                    No survey responses
                </p>
                <p style="font-size: 0.875rem; color: var(--text-secondary);">
                    Complete surveys after attending events to share your feedback
                </p>
            </div>
        <% } %>
    </div>

    <!-- Quick Actions Section -->
    <div class="card">
        <h2 class="card-header" style="margin-bottom: 1.5rem;">Quick Actions</h2>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <a href="/events" class="btn btn-secondary" style="text-align: center; padding: 1rem;">Register for Event</a>
            <a href="/events" class="btn btn-secondary" style="text-align: center; padding: 1rem;">View All Events</a>
            <a href="/contact" class="btn btn-secondary" style="text-align: center; padding: 1rem;">Contact Us</a>
        </div>
    </div>
<% } %>

<%- include('../partials/footer') %>


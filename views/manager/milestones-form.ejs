<%- include('../partials/header', { title: (milestoneData && milestoneData.id) ? 'Edit Milestone' : 'Add New Milestone', user: user || null }) %>

<div class="page-header">
    <h1><%= (milestoneData && milestoneData.id) ? 'Edit Milestone' : 'Add New Milestone' %></h1>
    <p><%= (milestoneData && milestoneData.id) ? 'Update milestone information' : 'Create a new milestone and assign to participant' %></p>
</div>

<div class="form-container">
    <form action="<%= (milestoneData && milestoneData.id) ? '/milestones/' + milestoneData.id + '/update' : '/milestones/new' %>" method="POST">
        <div class="form-group">
            <label for="milestone_name">Milestone Name *</label>
            <input type="text" id="milestone_name" name="milestone_name" value="<%= milestoneData ? (milestoneData.milestone_name || '') : '' %>" required>
        </div>
        <div class="form-group">
            <label for="milestone_type">Milestone Type *</label>
            <select id="milestone_type" name="milestone_type" required>
                <option value="">Select milestone type</option>
                <option value="education" <%= (milestoneData && milestoneData.milestone_type === 'education') ? 'selected' : '' %>>Education</option>
                <option value="career" <%= (milestoneData && milestoneData.milestone_type === 'career') ? 'selected' : '' %>>Career</option>
                <option value="personal" <%= (milestoneData && milestoneData.milestone_type === 'personal') ? 'selected' : '' %>>Personal Development</option>
                <option value="steam_graduation" <%= (milestoneData && milestoneData.milestone_type === 'steam_graduation') ? 'selected' : '' %>>STEAM Field Graduation</option>
                <option value="steam_job" <%= (milestoneData && milestoneData.milestone_type === 'steam_job') ? 'selected' : '' %>>STEAM Field Job</option>
                <option value="other" <%= (milestoneData && milestoneData.milestone_type === 'other') ? 'selected' : '' %>>Other</option>
            </select>
        </div>
        <div class="form-group">
            <label for="participant_search">Participant *</label>
            <input type="text" id="participant_search" name="participant_search" placeholder="Search participant by name or email..." autocomplete="off">
            <input type="hidden" id="participant_id" name="participant_id" value="<%= milestoneData ? (milestoneData.PersonID || milestoneData.ParticipantID || '') : '' %>" required>
            <div id="selected-participant" style="margin-top: 0.5rem; padding: 0.5rem; background: var(--pink-bg); border-radius: 4px; display: none;">
                <strong>Selected:</strong> <span id="selected-name"></span>
                <button type="button" id="clear-participant" style="margin-left: 1rem; padding: 0.25rem 0.5rem; background: var(--coral); color: white; border: none; border-radius: 4px; cursor: pointer;">Clear</button>
            </div>
            <div id="participant-results" style="display: none; max-height: 200px; overflow-y: auto; border: 1px solid var(--border-light); border-radius: 4px; margin-top: 0.5rem; background: white; box-shadow: 0 4px 12px rgba(0,0,0,0.1); position: absolute; z-index: 1000; width: 100%; max-width: 500px;"></div>
            <small style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-top: 0.25rem;">
                Type to search for a participant. Multiple milestones can be assigned to the same participant.
            </small>
        </div>
        
        <script>
            const participants = <%- JSON.stringify(participants || []) %>;
            const participantSearch = document.getElementById('participant_search');
            const participantIdInput = document.getElementById('participant_id');
            const resultsDiv = document.getElementById('participant-results');
            
            <% if (milestoneData && milestoneData.PersonID) { %>
                // Set initial value if editing
                const selectedParticipant = participants.find(p => (p.PersonID || p.personid) == <%= milestoneData.PersonID %>);
                if (selectedParticipant) {
                    participantSearch.value = (selectedParticipant.FirstName || selectedParticipant.firstname || '') + ' ' + (selectedParticipant.LastName || selectedParticipant.lastname || '');
                }
            <% } %>
            
            participantSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase().trim();
                resultsDiv.innerHTML = '';
                
                if (searchTerm.length < 2) {
                    resultsDiv.style.display = 'none';
                    participantIdInput.value = '';
                    return;
                }
                
                const filtered = participants.filter(p => {
                    const firstName = (p.FirstName || p.firstname || '').toLowerCase();
                    const lastName = (p.LastName || p.lastname || '').toLowerCase();
                    const fullName = (firstName + ' ' + lastName).trim();
                    const email = (p.Email || p.email || '').toLowerCase();
                    return fullName.includes(searchTerm) || email.includes(searchTerm);
                });
                
                if (filtered.length === 0) {
                    resultsDiv.innerHTML = '<div style="padding: 0.75rem; color: var(--text-secondary);">No participants found</div>';
                    resultsDiv.style.display = 'block';
                    return;
                }
                
                filtered.forEach(participant => {
                    const div = document.createElement('div');
                    div.style.padding = '0.75rem';
                    div.style.cursor = 'pointer';
                    div.style.borderBottom = '1px solid var(--border-light)';
                    const firstName = participant.FirstName || participant.firstname || '';
                    const lastName = participant.LastName || participant.lastname || '';
                    const email = participant.Email || participant.email || '';
                    div.innerHTML = '<strong>' + firstName + ' ' + lastName + '</strong><br><small style="color: var(--text-secondary);">' + email + '</small>';
                    
                    div.addEventListener('click', function() {
                        participantSearch.value = firstName + ' ' + lastName;
                        participantIdInput.value = participant.PersonID || participant.personid || '';
                        resultsDiv.style.display = 'none';
                        
                        // Show selected participant
                        document.getElementById('selected-name').textContent = firstName + ' ' + lastName;
                        document.getElementById('selected-participant').style.display = 'block';
                    });
                    
                    div.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = 'var(--pink-bg)';
                    });
                    div.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'white';
                    });
                    
                    resultsDiv.appendChild(div);
                });
                
                resultsDiv.style.display = 'block';
            });
            
            // Hide results when clicking outside
            document.addEventListener('click', function(e) {
                if (!participantSearch.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.style.display = 'none';
                }
            });
            
            // Clear participant button
            document.getElementById('clear-participant').addEventListener('click', function() {
                participantSearch.value = '';
                participantIdInput.value = '';
                document.getElementById('selected-participant').style.display = 'none';
                participantSearch.focus();
            });
        </script>
        <div class="form-group">
            <label for="achievement_date">Achievement Date *</label>
            <input type="date" id="achievement_date" name="achievement_date" value="<%= milestoneData ? (milestoneData.achievement_date || '') : '' %>" required>
        </div>
        <div class="form-group">
            <label for="status">Status *</label>
            <select id="status" name="status" required>
                <option value="">Select status</option>
                <option value="achieved" <%= (milestoneData && milestoneData.status === 'achieved') ? 'selected' : '' %>>Achieved</option>
                <option value="in_progress" <%= (milestoneData && milestoneData.status === 'in_progress') ? 'selected' : '' %>>In Progress</option>
                <option value="pending" <%= (milestoneData && milestoneData.status === 'pending') ? 'selected' : '' %>>Pending</option>
            </select>
        </div>
        <div class="form-group">
            <label for="description">Description</label>
            <textarea id="description" name="description" rows="4"><%= milestoneData ? (milestoneData.description || '') : '' %></textarea>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save</button>
            <a href="/milestones" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    // Form validation to ensure participant is selected
    document.querySelector('form').addEventListener('submit', function(e) {
        const participantId = document.getElementById('participant_id').value;
        if (!participantId || participantId.trim() === '') {
            e.preventDefault();
            alert('Please select a participant from the search results.');
            document.getElementById('participant_search').focus();
            return false;
        }
    });
</script>

<%- include('../partials/footer') %>


